<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIF Creator and Extractor</title>
    <style>
        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2a2a2a;
            --border: #3a3a3a;
            --text-primary: #f0f0f0;
            --text-secondary: #b0b0b0;
            --accent: #4a8eff;
            --accent-hover: #5a9eff;
            --warning: #ffa54a;
            --progress-bg: #3a3a3a;
            --progress-fill: #4a8eff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 24px;
            max-width: 800px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 40px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 16px;
        }

        section {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 32px;
        }

        h2 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        input[type="file"] {
            width: 100%;
            padding: 12px;
            background-color: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            cursor: pointer;
        }

        input[type="file"]:hover {
            border-color: var(--accent);
        }

        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            background-color: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
        }

        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .note {
            font-size: 14px;
            color: var(--warning);
            margin-top: 8px;
            margin-bottom: 16px;
        }

        button {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: background-color 0.2s;
            width: 100%;
        }

        button:hover {
            background-color: var(--accent-hover);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .progress-container {
            margin-top: 20px;
        }

        progress {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
        }

        progress::-webkit-progress-bar {
            background-color: var(--progress-bg);
            border-radius: 3px;
        }

        progress::-webkit-progress-value {
            background-color: var(--progress-fill);
            border-radius: 3px;
        }

        progress::-moz-progress-bar {
            background-color: var(--progress-fill);
            border-radius: 3px;
        }

        .progress-text {
            text-align: center;
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        @media (min-width: 600px) {
            .form-row {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>GIF Creator and Extractor</h1>
        <p class="subtitle">Convert images to GIF and extract frames from GIF files</p>
        <button id="backButton" style="margin-top: 20px; background-color: transparent; border: 1px solid var(--border); color: var(--text-secondary);" onclick="location.href='/'">Back to Home</button>
    </header>

    <section id="creator-section">
        <h2>Create GIF from Images</h2>
        
        <div class="form-group">
            <label for="imageInput">Select Image Files</label>
            <input type="file" id="imageInput" multiple accept="image/jpeg,image/png,image/gif,image/webp">
            <p class="note">Maximum 500 images. Some formats may be skipped due to browser limitations.</p>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="frameDelay">Frame Delay (ms)</label>
                <input type="number" id="frameDelay" value="100" min="20" max="5000">
            </div>

            <div class="form-group">
                <label for="loopCount">Loop Count</label>
                <select id="loopCount">
                    <option value="0">Infinite</option>
                    <option value="1">Once</option>
                    <option value="2">Twice</option>
                    <option value="3">Three times</option>
                </select>
            </div>

            <div class="form-group">
                <label for="scaleFactor">Scale Factor</label>
                <input type="number" id="scaleFactor" value="1" step="0.1" min="0.1" max="5">
            </div>
        </div>

        <button id="createGifBtn">Create GIF</button>
        
        <div class="progress-container" style="display: none;" id="creatorProgress">
            <progress id="gifProgress" value="0" max="100"></progress>
            <div class="progress-text" id="gifProgressText">Processing...</div>
        </div>
    </section>

    <section id="extractor-section">
        <h2>Extract Frames from GIF</h2>
        
        <div class="form-group">
            <label for="gifInput">Select GIF File</label>
            <input type="file" id="gifInput" accept="image/gif">
        </div>

        <button id="extractGifBtn">Extract Frames and Download ZIP</button>
        
        <div class="progress-container" style="display: none;" id="extractorProgress">
            <progress id="zipProgress" value="0" max="100"></progress>
            <div class="progress-text" id="zipProgressText">Processing...</div>
        </div>
    </section>

    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js"></script>
    <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>

    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: false });
        let isFFmpegLoaded = false;

        // DOM Elements
        const elements = {
            imageInput: document.getElementById('imageInput'),
            gifInput: document.getElementById('gifInput'),
            frameDelay: document.getElementById('frameDelay'),
            loopCount: document.getElementById('loopCount'),
            scaleFactor: document.getElementById('scaleFactor'),
            createGifBtn: document.getElementById('createGifBtn'),
            extractGifBtn: document.getElementById('extractGifBtn'),
            creatorProgress: document.getElementById('creatorProgress'),
            extractorProgress: document.getElementById('extractorProgress'),
            gifProgress: document.getElementById('gifProgress'),
            zipProgress: document.getElementById('zipProgress'),
            gifProgressText: document.getElementById('gifProgressText'),
            zipProgressText: document.getElementById('zipProgressText')
        };

        async function loadFFmpeg() {
            if (!isFFmpegLoaded) {
                try {
                    elements.createGifBtn.disabled = true;
                    elements.extractGifBtn.disabled = true;
                    elements.createGifBtn.textContent = 'Loading FFmpeg...';
                    
                    await ffmpeg.load();
                    isFFmpegLoaded = true;
                    
                    elements.createGifBtn.disabled = false;
                    elements.extractGifBtn.disabled = false;
                    elements.createGifBtn.textContent = 'Create GIF';
                } catch (error) {
                    console.error('Failed to load FFmpeg:', error);
                    alert('Failed to load FFmpeg. Please refresh the page and try again.');
                }
            }
        }

        async function createGif() {
            const files = Array.from(elements.imageInput.files).slice(0, 500);
            if (files.length === 0) {
                alert('Please select at least one image file.');
                return;
            }

            await loadFFmpeg();
            
            elements.createGifBtn.disabled = true;
            elements.creatorProgress.style.display = 'block';
            elements.gifProgress.value = 0;
            elements.gifProgressText.textContent = 'Initializing...';

            try {
                // Create input directory
                ffmpeg.FS('mkdir', '/input');

                // Write files to virtual filesystem
                for (let i = 0; i < files.length; i++) {
                    try {
                        const file = files[i];
                        const data = await fetchFile(file);
                        ffmpeg.FS('writeFile', `/input/${i}.png`, data);
                        
                        // Update progress
                        const progress = Math.round((i / files.length) * 50);
                        elements.gifProgress.value = progress;
                        elements.gifProgressText.textContent = `Processing images: ${i + 1}/${files.length}`;
                    } catch (error) {
                        console.warn(`Skipped file ${files[i].name}:`, error);
                    }
                }

                const delay = elements.frameDelay.value;
                const loop = elements.loopCount.value;
                const scale = elements.scaleFactor.value;

                elements.gifProgressText.textContent = 'Creating GIF...';
                elements.gifProgress.value = 50;

                // Run FFmpeg command
                await ffmpeg.run(
                    '-framerate', String(1000 / delay),
                    '-i', '/input/%d.png',
                    '-vf', `scale=iw*${scale}:ih*${scale}:flags=lanczos`,
                    '-loop', loop,
                    '-f', 'gif',
                    'output.gif'
                );

                elements.gifProgress.value = 90;
                elements.gifProgressText.textContent = 'Finalizing...';

                // Read and download the result
                const data = ffmpeg.FS('readFile', 'output.gif');
                const blob = new Blob([data.buffer], { type: 'image/gif' });
                downloadFile(blob, 'created.gif');

                elements.gifProgress.value = 100;
                elements.gifProgressText.textContent = 'Complete!';

            } catch (error) {
                console.error('Error creating GIF:', error);
                alert('Failed to create GIF. Please check the console for details.');
            } finally {
                elements.createGifBtn.disabled = false;
                setTimeout(() => {
                    elements.creatorProgress.style.display = 'none';
                }, 2000);
            }
        }

        async function extractGif() {
            const file = elements.gifInput.files[0];
            if (!file) {
                alert('Please select a GIF file.');
                return;
            }

            await loadFFmpeg();
            
            elements.extractGifBtn.disabled = true;
            elements.extractorProgress.style.display = 'block';
            elements.zipProgress.value = 0;
            elements.zipProgressText.textContent = 'Initializing...';

            try {
                // Write GIF to virtual filesystem
                const data = await fetchFile(file);
                ffmpeg.FS('writeFile', 'input.gif', data);

                elements.zipProgressText.textContent = 'Extracting frames...';
                elements.zipProgress.value = 30;

                // Extract frames
                await ffmpeg.run(
                    '-i', 'input.gif',
                    'frame_%04d.png'
                );

                elements.zipProgressText.textContent = 'Creating ZIP file...';
                elements.zipProgress.value = 60;

                // Create ZIP file
                const zip = new JSZip();
                const files = ffmpeg.FS('readdir', '/').filter(f => f.startsWith('frame_'));

                for (let i = 0; i < files.length; i++) {
                    const filename = files[i];
                    const frameData = ffmpeg.FS('readFile', filename);
                    zip.file(filename, frameData);
                    
                    const progress = 60 + Math.round((i / files.length) * 35);
                    elements.zipProgress.value = progress;
                    elements.zipProgressText.textContent = `Adding frames to ZIP: ${i + 1}/${files.length}`;
                }

                elements.zipProgressText.textContent = 'Generating download...';
                elements.zipProgress.value = 95;

                const zipBlob = await zip.generateAsync({ type: 'blob' });
                downloadFile(zipBlob, 'gif_frames.zip');

                elements.zipProgress.value = 100;
                elements.zipProgressText.textContent = 'Complete!';

            } catch (error) {
                console.error('Error extracting GIF:', error);
                alert('Failed to extract GIF frames. Please check the console for details.');
            } finally {
                elements.extractGifBtn.disabled = false;
                setTimeout(() => {
                    elements.extractorProgress.style.display = 'none';
                }, 2000);
            }
        }

        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Event Listeners
        elements.createGifBtn.addEventListener('click', createGif);
        elements.extractGifBtn.addEventListener('click', extractGif);

        // Preload FFmpeg when user interacts with the page
        document.addEventListener('click', () => {
            if (!isFFmpegLoaded) {
                loadFFmpeg();
            }
        }, { once: true });

        // Back button
        const backButton = document.getElementById('backButton');
        backButton.addEventListener('mouseenter', () => {
            backButton.style.backgroundColor = 'var(--bg-primary)';
            backButton.style.color = 'var(--text-primary)';
        });
        
        backButton.addEventListener('mouseleave', () => {
            backButton.style.backgroundColor = 'transparent';
            backButton.style.color = 'var(--text-secondary)';
        });
    </script>
</body>
</html>