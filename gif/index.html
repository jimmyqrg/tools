<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GIF Creator and Extractor</title>

<style>
:root{
  --bg:#111;
  --panel:#1e1e1e;
  --border:#333;
  --text:#f0f0f0;
  --muted:#aaa;
  --accent:#4a8eff;
  --accent-hover:#6aa2ff;
  --warn:#ffa54a;
}

*{box-sizing:border-box}

body{
  margin:0;
  padding:24px;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:var(--bg);
  color:var(--text);
  max-width:900px;
  margin:auto;
}

header{
  border-bottom:1px solid var(--border);
  padding-bottom:16px;
  margin-bottom:32px;
}

section{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:12px;
  padding:24px;
  margin-bottom:32px;
}

h1{margin:0 0 6px}
.subtitle{color:var(--muted)}

button{
  width:100%;
  padding:14px;
  background:var(--accent);
  color:#fff;
  border:none;
  border-radius:8px;
  font-weight:600;
  font-size:16px;
  cursor:pointer;
}
button:hover{background:var(--accent-hover)}

.back-btn{
  margin-top:16px;
  background:transparent;
  border:1px solid var(--border);
  color:var(--muted);
}
.back-btn:hover{
  background:var(--bg);
  color:var(--text);
  border-color:var(--accent);
}

/* DROP ZONE */
#dropZone{
  margin-top:16px;
  border:2px dashed var(--border);
  border-radius:12px;
  padding:40px 20px;
  text-align:center;
  color:var(--muted);
  cursor:pointer;
  transition:.2s;
}
#dropZone.drag{
  border-color:var(--accent);
  color:var(--accent);
  background:#0a1a33;
}

/* PREVIEW GRID */
#preview{
  display:grid;
  grid-template-columns:repeat(auto-fill,80px);
  gap:10px;
  margin-top:16px;
}
.frame{
  width:80px;
  height:80px;
  background:#000;
  border:1px solid var(--border);
  border-radius:6px;
  overflow:hidden;
  cursor:grab;
}
.frame.dragging{opacity:.4}
.frame img{
  width:100%;
  height:100%;
  object-fit:contain;
}

label{display:block;margin-top:16px;color:var(--muted)}
input,select{
  width:100%;
  padding:10px;
  background:#000;
  border:1px solid var(--border);
  border-radius:6px;
  color:var(--text);
}

.form-row{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:16px;
}

progress{
  width:100%;
  height:8px;
  margin-top:12px;
}
.note{font-size:14px;color:var(--warn);margin-top:6px}
</style>
</head>

<body>

<header>
  <h1>GIF Creator and Extractor</h1>
  <div class="subtitle">Create GIFs or extract frames</div>
  <button class="back-btn" onclick="location.href='/'">‚Üê Back to Home</button>
</header>

<section>
<h2>Create GIF</h2>

<!-- DROP ZONE -->
<div id="dropZone">
  <strong>Click to upload</strong> or drag in your files<br>
  <span style="font-size:14px">Up to 500 images</span>
</div>

<input type="file" id="fileInput" multiple accept="image/*" hidden>

<div id="preview"></div>

<div class="form-row">
  <div>
    <label>Frame Delay (ms)</label>
    <input type="number" id="delay" value="100" min="20">
  </div>
  <div>
    <label>Loop</label>
    <select id="loop">
      <option value="0">Infinite</option>
      <option value="1">Once</option>
      <option value="2">Twice</option>
    </select>
  </div>
  <div>
    <label>Scale</label>
    <input type="number" id="scale" value="1" step="0.1" min="0.1">
  </div>
</div>

<button id="makeGif">Create GIF</button>
<progress id="gifProgress" value="0" max="100" style="display:none"></progress>
</section>

<section>
<h2>Extract GIF Frames</h2>
<input type="file" id="gifInput" accept="image/gif">
<button id="extractGif">Extract & Download ZIP</button>
<progress id="zipProgress" value="0" max="100" style="display:none"></progress>
</section>

<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js"></script>
<script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>

<script>
const { createFFmpeg, fetchFile } = FFmpeg;
const ffmpeg = createFFmpeg({ log:false });
let loaded=false;
let images=[];

const $=id=>document.getElementById(id);

/* LOAD FFMPEG */
async function loadFF(){
  if(!loaded){
    $('makeGif').disabled = true;
    $('extractGif').disabled = true;
    $('makeGif').textContent = 'Loading FFmpeg...';
    $('extractGif').textContent = 'Loading FFmpeg...';
    
    try {
      await ffmpeg.load();
      loaded=true;
      console.log('FFmpeg loaded successfully');
      
      $('makeGif').disabled = false;
      $('extractGif').disabled = false;
      $('makeGif').textContent = 'Create GIF';
      $('extractGif').textContent = 'Extract & Download ZIP';
    } catch (error) {
      console.error('Failed to load FFmpeg:', error);
      alert('Failed to load FFmpeg. Please refresh the page and try again.');
      $('makeGif').textContent = 'Create GIF';
      $('extractGif').textContent = 'Extract & Download ZIP';
    }
  }
}

/* DROP ZONE LOGIC */
const dropZone=$('dropZone');
const fileInput=$('fileInput');

dropZone.onclick=()=>fileInput.click();

dropZone.ondragover=e=>{
  e.preventDefault();
  dropZone.classList.add('drag');
};
dropZone.ondragleave=()=>dropZone.classList.remove('drag');
dropZone.ondrop=e=>{
  e.preventDefault();
  dropZone.classList.remove('drag');
  handleFiles(e.dataTransfer.files);
};

fileInput.onchange=()=>handleFiles(fileInput.files);

function handleFiles(files){
  images=[...files].slice(0,500);
  renderPreview();
}

/* PREVIEW + DRAG REORDER */
function renderPreview(){
  const box=$('preview');
  box.innerHTML='';
  images.forEach((file,i)=>{
    const d=document.createElement('div');
    d.className='frame';
    d.draggable=true;

    const img=document.createElement('img');
    img.src=URL.createObjectURL(file);
    d.appendChild(img);
    box.appendChild(d);

    d.ondragstart=e=>{
      d.classList.add('dragging');
      e.dataTransfer.setData('i',i);
    };
    d.ondragend=()=>d.classList.remove('dragging');
    d.ondragover=e=>e.preventDefault();
    d.ondrop=e=>{
      e.preventDefault();
      const from=+e.dataTransfer.getData('i');
      images.splice(i,0,images.splice(from,1)[0]);
      renderPreview();
    };
  });
}

/* CREATE GIF */
$('makeGif').onclick=async()=>{
  console.log('Create GIF button clicked');
  
  if(!images.length){
    alert('Please select images first');
    return;
  }
  
  await loadFF();
  if(!loaded) return;

  $('gifProgress').style.display='block';
  $('gifProgress').value=0;
  $('makeGif').disabled = true;
  $('makeGif').textContent = 'Creating GIF...';

  try{
    try{ffmpeg.FS('mkdir','/in')}catch{}
    ffmpeg.FS('readdir','/in').forEach(f=>ffmpeg.FS('unlink','/in/'+f));

    for(let i=0;i<images.length;i++){
      ffmpeg.FS('writeFile',`/in/${i}.png`,await fetchFile(images[i]));
      $('gifProgress').value=(i/images.length)*50;
    }

    await ffmpeg.run(
      '-framerate',String(1000/+$('delay').value),
      '-i','/in/%d.png',
      '-vf',`scale=iw*${$('scale').value}:ih*${$('scale').value}`,
      '-loop',$('loop').value,
      'out.gif'
    );

    const data=ffmpeg.FS('readFile','out.gif');
    download(new Blob([data.buffer],{type:'image/gif'}),'created.gif');
    $('gifProgress').value=100;
  }catch(e){
    console.error(e);
    alert('Failed to create GIF: ' + e.message);
  } finally {
    $('makeGif').disabled = false;
    $('makeGif').textContent = 'Create GIF';
    setTimeout(() => {
      $('gifProgress').style.display = 'none';
      $('gifProgress').value = 0;
    }, 2000);
  }
};

/* EXTRACT GIF */
$('extractGif').onclick=async()=>{
  console.log('Extract GIF button clicked');
  
  const f=$('gifInput').files[0];
  if(!f){
    alert('Please select a GIF file');
    return;
  }
  
  await loadFF();
  if(!loaded) return;

  $('zipProgress').style.display='block';
  $('extractGif').disabled = true;
  $('extractGif').textContent = 'Extracting...';

  try {
    ffmpeg.FS('writeFile','in.gif',await fetchFile(f));
    await ffmpeg.run('-i','in.gif','frame_%04d.png');

    const zip=new JSZip();
    const frames = ffmpeg.FS('readdir','/').filter(f=>f.startsWith('frame_'));
    
    for(let i=0; i<frames.length; i++){
      zip.file(frames[i],ffmpeg.FS('readFile',frames[i]));
      $('zipProgress').value = ((i+1) / frames.length) * 100;
    }

    download(await zip.generateAsync({type:'blob'}),'frames.zip');
    $('zipProgress').value=100;
  } catch(e) {
    console.error(e);
    alert('Failed to extract GIF: ' + e.message);
  } finally {
    $('extractGif').disabled = false;
    $('extractGif').textContent = 'Extract & Download ZIP';
    setTimeout(() => {
      $('zipProgress').style.display = 'none';
      $('zipProgress').value = 0;
    }, 2000);
  }
};

/* SAFE DOWNLOAD */
function download(blob,name){
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=name;
  document.body.appendChild(a);
  setTimeout(()=>{
    a.click();
    setTimeout(()=>{
      URL.revokeObjectURL(url);
      a.remove();
    },1000);
  },50);
}

// Preload FFmpeg on first user interaction
document.addEventListener('click', () => {
  if(!loaded && images.length > 0){
    loadFF();
  }
}, { once: true });

console.log('Script loaded successfully');
</script>

</body>
</html>
